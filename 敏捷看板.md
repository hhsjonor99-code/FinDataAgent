# 敏捷看板记录

## Sprint0
    看板制定时间：12月19日晚9：00
    迭代目标：最小可行性框架，实现“自然语言 -> 知识检索 -> 代码生成 -> 执行 -> 产出文件”的最小用例实现，要求具备良好的可拓展性
            使用包含"知识库","Agent引擎","读写跑以及画图工具","工作空间"四个模块的结构

    完整项目代办：
        
        1.验收Sprint0后设计并完成相关优化
        2.增加知识库条目，以支持更加丰富多样化的内容
        3.通过tkinter快速构建简单使用的用户界面

### 本次Sprint待办
    1.基础文件夹结构建立
    2.获取 Tushare & DS 密钥
    3.编写Agent引擎，包括核心prompt设计等
    4.在工具模块中完成code_excuter.py以及最小用例实现所需的绘图函数
    5.为知识库添加为实现最小用例所需的知识条目
    6.集成以上的功能模块，跑通工作流

### 本次Sprint结算
    结算时间： 12月20日上午9：00

#### 目前代码结构以及功能
    - 项目结构：`core/` `tools/` `knowledge_base/` `workspace/` `gui/`
    - 核心能力：自然语言意图解析 → 加载知识库 → LLM 生成 Python 脚本 → 本地执行 → 输出结果路径
    - 知识库：
        - `tushare_schema.json` 定义 `tushare.daily` 的函数名、参数与示例
        - `tool_docs.json` 定义 `plot_line_chart` 的函数签名与示例
    - 工具层：
        - `code_executor.py` 将生成代码写入 `workspace/temp_scripts/` 并执行，返回 stdout
        - `plot_utils.py` 提供折线图绘制与保存
        - `tushare_api.py` 统一初始化并封装数据获取与导出（后备使用）
    - Agent 引擎：
        - `run_min_workflow(intent)` 负责整合知识库与 Prompt，调用 DeepSeek，并执行生成脚本
        - `knowledge_manager.py` 负责解析意图，但目前采用硬编码方式
        - Prompt 强化：明确通过 `dotenv + os.getenv('TUSHARE_TOKEN')` 初始化 Token，要求只打印最终文件路径
    - GUI：
        - `main.py` 提供简易 Tkinter 界面，输入自然语言一键执行并展示日志
    - 测试用例：
        - `min_test.py` 包含 Excel 导出与绘图两类场景测试
    

#### 接下来的项目整体代办

    - core/knowlegde_manager.py
        - 目前采用硬编码方式进行意图解析
        - 需要使用deepseek的api进行意图解析，以支持更加复杂的意图
        - 该文件命名有语法错误，修正为 `knowledge_manager.py` 并在其它各个地方对应修改

    - run_min_workflow 优化，要求内部包含以下逻辑：
        - 运行脚本前清除 `workspace/temp_scripts/` 目录下历史脚本（仅保留最新一次，避免干扰）
        - 保留 `workspace/exports/` 历史产物，避免误删；可按日期分目录或追加 `_{timestamp}` 做留存
        -run_min_workflow函数名称改为agent_workflow,在各处的调用都需要对应修改

    - 稳健性：统一脚本初始化模板片段（Token、排序、路径打印），减少 LLM 偏差   

    - 规范workspace中临时文件的命名规范，避免冲突
        - `workspace/temp_scripts/` 中脚本命名为 `agent_exec.py`
        - `workspace/exports/` 中文件命名为 `{ts_code}_{start_date}_{end_date}{ext}`，必要时追加 `_{timestamp}` 保证唯一性（如并发或重复请求）

    - 知识库扩充：增加更多 Tushare 接口条目与丰富的绘图函数（K线、子图、多轴）
    - GUI 体验：增加进度提示、错误详情与“打开文件夹”入口
    - 检索增强：将“全量投喂”改为 Top-K 检索（关键词过滤 → 向量检索）
    - 考虑在 Docker 容器或受限的沙箱环境中运行生成的代码(软件安全工程)
    


## Sprint1
    看板制定时间：12月20日上午11：00
    迭代目标：优化工作流框架
### 本次Sprint待办

    - core/knowlegde_manager.py （优先级最高！）
        - 目前采用硬编码方式进行意图解析
        - 需要使用deepseek的api进行意图解析，以支持更加复杂的意图
        - 该文件命名有语法错误，修正为 `knowledge_manager.py` 并在其它各个地方对应修改

    - run_min_workflow 优化，要求内部包含以下逻辑：
        - 运行脚本前清除 `workspace/temp_scripts/` 目录下历史脚本（仅保留最新一次，避免干扰）
        - 保留 `workspace/exports/` 历史产物，避免误删；可按日期分目录或追加 `_{timestamp}` 做留存
        -run_min_workflow函数名称改为agent_workflow,在各处的调用都需要对应修改

    - 稳健性：统一脚本初始化模板片段（Token、排序、路径打印），减少 LLM 偏差   

### 本次Sprint结算
    结算时间： 12月20日下午3：00
    完成了使用LLM进行意图分析的改进，同时完成了两条细微优化

#### 遇见问题
    目前的意图分析是基于预设了用户所需数据与绘图皆于股票相关的的假设，为了支持功能拓展，需要对意图分析进行改进，以支持更加复杂的意图

    改进思路:
        -将意图分析修正为基于deepseek的LLM进行的，由知识库条目驱动的意图分析



## Sprint2
    看板制定时间：12月20日下午3：10
    迭代目标：完善意图分析，增加Agent日志记录模块

### 本次Sprint待办
    - 完善意图分析：
        - 重构为由知识库条目驱动，支持更加复杂的意图

### 本次Sprint结算
    结算时间： 12月20日下午4：30
    - 原先的工作流逻辑中，LLM只是负责按照知识库中提供的函数生成代码，代码的自由度受到很大的限制
      LLM的能力没能完全发挥出来，因此决定重构智能体逻辑，使其实现自由对话，自我代码纠错等功能
  

## Sprint3
    看板制定时间：12月20日下午5：00
    迭代目标：重构Agent逻辑为Code Interpreter模式，引入uv包管理，移除LangChain依赖

### 本次Sprint待办
    - 核心架构重构：
        - 废弃 `Intent Classification + Slot Filling` 模式
        - 实现 `Think -> Code -> Execute -> Observe -> Self-Correction` 的 Code Interpreter 模式
        - `agent_engine.py`: 重写为 System Prompt 驱动，支持多轮自动纠错
        - `knowledge_manager.py`: 简化为纯文档检索，不再进行参数提取
        - `code_executor.py`: 增加 Pre-amble 注入（自动 Token/Import）与输出捕获增强

    - 技术栈优化：
        - 移除 `LangChain`，改用原生 `OpenAI` SDK 直连 DeepSeek，提升稳定性与错误控制
        - 引入 `uv` 包管理器，生成 `pyproject.toml` 和 `uv.lock`，实现确定性依赖管理

### 本次Sprint结算：
     结算时间： 12月20日下午 8：00
    - 原先的工作流逻辑中，LLM只是负责按照知识库中提供的函数生成代码，代码的自由度受到很大的限制
      LLM的能力没能完全发挥出来，因此决定重构智能体逻辑，使其实现自由对话，自我代码纠错等功能
    - 引入uv包管理器，生成pyproject.toml和uv.lock，实现确定性依赖管理

    本次Sprint取得重大成果突破
    
        1.  **从“硬编码”到“推理引擎”的跃迁**：
            *   *之前*：我们预设了大量的规则，像是在走迷宫，一旦用户需求超纲，系统就瘫痪。
            *   *现在*：我们构建了一个 **闭环控制系统**。系统拥有了“感知-行动-观察-修正”的能力。

        2.  **解决“幻觉”的新思路**：
            *   大模型会有“幻觉”（乱写代码）。我们不强求它一次写对，而是建立了一个 **Runtime（运行环境）**。让真实的环境（Python 执行器）去校验代码，通过报错信息来纠正模型的幻觉。

        3.  **标准化输出协议**：
            *   通过 `OUTPUT_PATH:` 这个协议，我们统一了“代码运行结果”与“Agent 业务逻辑”之间的接口，解决了代码执行后文件在哪里的痛点。

        4.  **鲁棒性（Robustness）**：
            *   `max_retries = 3` 的设计保证了系统在面对 Tushare 接口变动或网络波动时，有自我修复的机会，而不是直接给用户抛出错误代码。

     
## Sprint4
    看板制定时间：12月20晚8：10
    迭代目标：1.设计优美的用户界面，实现用户与智能体的交互
            2.增加知识库条目，支持更多的金融数据查询与分析
            3.测试大量用例，确保系统的稳定性与鲁棒性

