这是一个根据你的最新要求修改后的软件需求规格说明书（SRS）。

本次修改重点调整了**“3.1 自然语言指令处理与 Agent 核心”**及相关描述，明确了系统摒弃“预制大量工具”的传统模式，转而采用“全自由度 Python 脚本生成”的纯代码解释器（Code Interpreter）架构。其余部分保持了原有内容的扎实与丰富。

---

# 软件需求规格说明书：基于 LLM Agent 的 Tushare 金融数据分析系统

## 1. 引言

### 1.1 编写目的

本需求规格说明书旨在明确“基于 LLM Agent 的 Tushare 金融数据分析系统”的功能、性能及系统架构要求，为后续的开发、测试及验收提供核心依据。本项目的核心目标是构建一个轻量级的智能数据分析原型，打破传统开发中需为每个功能预写代码的限制，通过赋予 AI 自由编写脚本的能力，使非编程专业用户也能通过自然语言灵活地获取和分析金融数据。

### 1.2 项目背景与范围

本项目立足于“极简开发”与“零外部依赖风险”的背景。系统设计为一个集成大语言模型（LLM）逻辑推理能力的桌面端应用程序。与传统系统不同，本项目不预设固定的业务功能模块，而是将系统打造为一个通用的金融数据编程环境。系统范围涵盖通过自然语言驱动 AI 自动编写并执行 Python 脚本，从而实现 Tushare 数据获取、自定义清洗逻辑、策略计算以及数据可视化（折线图绘制）等任务。

## 2. 总体描述

### 2.1 用户特征

目标用户主要为金融分析师、相关专业学生或个人投资者。该群体具备扎实的金融业务逻辑（如理解 K 线、移动平均、收益率波动），但不具备熟练的 Python 编程能力。用户期望通过自然语言直接描述业务需求，而由系统在后台自动完成代码层面的实现与执行。

### 2.2 运行环境

系统基于标准 Python 环境运行，深度利用 Python 生态的成熟度。用户端需具备网络连接以访问 LLM 服务及 Tushare 数据接口。GUI 框架采用 Python 标准库 Tkinter，确保系统能在 Windows 或 macOS 操作系统上“开箱即用”，无需复杂的环境配置或额外的第三方 GUI 库安装。

## 3. 详细功能需求

### 3.1 自由式 Python 脚本生成引擎（核心变更）

系统架构明确**摒弃预制大量细分工具（Pre-made Tools）的传统 Agent 模式**，不再为每一个具体的金融指标或操作编写独立的函数调用接口。核心模块将构建为一个高自由度的“代码解释器”（Code Interpreter）。系统直接向 LLM 暴露一个完整的 Python 执行环境，允许 AI 根据用户的自然语言指令，自主规划逻辑并编写完整的 Python 脚本来解决问题。无论是简单的数据查询，还是复杂的“获取数据 -> 清洗异常值 -> 计算指标 -> 绘制图表”组合流程，均由 AI 动态生成的脚本一次性覆盖。这种设计极大地降低了开发初期的代码工作量，同时赋予了系统近乎无限的扩展能力。

### 3.2 动态上下文与脚本执行环境

为了确保 AI 自由编写的脚本能够成功运行，系统必须在执行环境中建立稳健的“前置依赖”。在 AI 生成的代码执行前，系统会自动注入一段不可见的“前置脚本”（Pre-amble），其中包含 Tushare Token 的初始化认证、核心数据分析库（Pandas, Matplotlib）的预导入以及绘图后端的静默配置。通过这种机制，AI 生成的脚本无需处理繁琐的环境配置，可直接调用 `pro.daily()` 或 `pd.DataFrame` 等对象，确保代码“即写即用”。

### 3.3 知识增强与接口规范引导

虽然系统允许 AI 自由写代码，但为了防止 AI 在调用 Tushare 接口时出现参数错误（幻觉），系统需通过 System Prompt 层面进行“知识增强”。系统不定义工具函数，而是将常用 Tushare 接口（如 `daily`, `pro_bar`）的参数文档（Schema）作为“参考手册”直接喂给 LLM。对于冷门数据需求，系统支持检索轻量级 JSON 知识库，将对应的接口定义动态补充到 Prompt 中。这相当于给 AI 程序员配备了一本随时可查的 API 开发文档，确保其编写的代码准确无误。

### 3.4 交互式反馈与连续业务流

系统需具备类似“Jupyter Notebook”的交互体验。每当 AI 编写的脚本执行完毕后，系统应自动捕获运行结果——包括标准输出（Stdout）、错误信息（Stderr）以及内存中 DataFrame 的数据预览（如 `df.head()`），并将这些信息作为“观察结果”（Observation）回传给上下文。这使得用户可以进行迭代式提问（例如：“基于刚才的数据，把计算周期改为 60 天”），AI 能够读取上一轮执行后的内存状态，继续编写新的脚本进行增量处理，实现业务逻辑的连续流转。

### 3.5 异步可视化与界面集成

系统界面由 Tkinter 构建，主要包含指令输入区、执行日志区和图表展示区。针对数据可视化需求，系统要求 AI 在编写绘图代码时，利用 Pandas 和 Matplotlib 将图表保存为本地图片文件（如 `./temp/plot.png`），而非直接弹窗显示。UI 线程将通过监控该文件的生成状态，利用 Label 组件动态加载并展示图表。这种“后端绘图、前端展示”的解耦模式，有效避免了脚本执行阻塞界面响应的问题。

## 4. 非功能需求

### 4.1 系统响应性与并发模型

鉴于金融数据下载和脚本执行均为耗时操作，系统必须严格执行 UI 与业务逻辑分离的并发模型。Agent 的脚本生成与执行过程必须运行在独立的守护线程（Daemon Thread）中。线程间通过 `queue.Queue` 进行消息传递，确保在脚本运行期间，主界面依然能流畅响应用户的滚动、缩放等操作，并实时更新执行日志。

### 4.2 容错与自动修正机制

面对 AI 生成代码可能存在的语法错误或逻辑漏洞，系统应具备自动修正回路。当脚本执行抛出异常时，系统需捕获详细的报错堆栈信息，并将其反馈给 AI。AI 应被训练为能根据报错信息分析原因（如“参数名拼写错误”或“数据为空”），并自动重新编写修正后的脚本再次尝试执行，直至运行成功或达到重试上限，从而最大程度减少用户的人工干预。

### 4.3 安全性与沙箱限制

给予 AI 自由编写脚本的权限带来了潜在的安全风险。因此，系统必须在 System Prompt 中设置明确的“红线”。明确禁止生成涉及文件系统删除（`os.remove`）、进程终止或网络攻击性质的 Python 代码。在代码提交执行前，系统需增加一道基础的字符串匹配过滤器，拦截包含敏感关键词（如 `shutil.rmtree`）的脚本，确保本地运行环境的安全性。

## 5. 结论

本规格说明书确立了以“自由脚本生成”为核心的系统架构。通过放弃繁琐的预制工具开发，转而利用 LLM 强大的代码生成能力结合 Tushare 与 Pandas 生态，系统能够在极短的开发周期内交付。该方案不仅大幅降低了开发成本，更通过“代码解释器”模式为用户提供了极高的业务灵活性，是实现轻量级金融数据分析助手最为切实可行的路径。