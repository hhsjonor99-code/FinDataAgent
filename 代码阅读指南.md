# 📚 FinDataAgent 代码阅读指南（小白版）

## 🎯 学习目标
理解这个项目如何工作：从用户输入自然语言 → LLM生成代码 → 执行代码 → 返回结果

---

## 📖 阅读顺序（从简单到复杂）

### 第一阶段：理解项目入口（最简单）

#### 1. 先看 `main.py` ⭐⭐⭐
**为什么先看这个？** 这是命令行版本的入口，代码最简单，能快速理解整个流程。

**关键点：**
- 第23行：获取用户输入
- 第33行：调用 `agent_workflow(user_input)` - 这是核心！
- 第35-38行：显示结果

**理解重点：**
```
用户输入 → agent_workflow() → 返回结果
```

#### 2. 再看 `min_test.py` ⭐⭐
**为什么看这个？** 这里有各种测试用例，可以看到系统能做什么。

**关键点：**
- 看第27行、第35行、第45行等测试用例
- 理解用户可以用自然语言描述需求

---

### 第二阶段：理解核心工作流（核心！）

#### 3. 重点看 `core/agent_engine.py` ⭐⭐⭐⭐⭐
**这是整个项目的核心！** 建议分段阅读：

**第一步：看函数签名（第28行）**
```python
def agent_workflow(intent: str):
```
- 输入：用户意图（自然语言）
- 输出：成功标志 + 结果

**第二步：看工作流程（第28-132行）**
整个流程分为5步：
1. **第62行**：获取知识库内容
2. **第65行**：构建提示词（告诉LLM要做什么）
3. **第84-89行**：调用LLM生成代码
4. **第104行**：执行生成的代码
5. **第118-124行**：如果失败，自动重试（自我修正）

**第三步：理解代码提取（第15-25行）**
```python
def _extract_code(text: str) -> str:
```
- LLM返回的是文本，需要从中提取Python代码块
- 使用正则表达式找 ```python ... ``` 之间的内容

**第四步：看流式版本（第135-236行）**
- `agent_workflow_streaming` 是GUI版本
- 区别：实时返回进度，而不是等全部完成

---

### 第三阶段：理解代码执行（重要）

#### 4. 看 `tools/code_executor.py` ⭐⭐⭐⭐
**这个文件负责执行LLM生成的代码**

**关键点：**

**第11-48行：前置代码（Preamble）**
- 这是自动注入到用户代码前面的代码
- 包含：导入库、初始化Tushare、配置Matplotlib等
- **为什么需要？** 让LLM生成的代码可以直接运行，不需要重复写这些

**第50-90行：执行函数**
```python
def run_python_code(code_str: str, ...):
```
- 第71行：把前置代码 + 用户代码合并
- 第76行：在子进程中执行（安全隔离）
- 第82行：设置超时600秒
- 第84行：返回执行结果

**理解重点：**
```
LLM生成的代码 → 加上前置代码 → 在子进程执行 → 返回结果
```

---

### 第四阶段：理解知识库（辅助理解）

#### 5. 看 `core/knowledge_manager.py` ⭐⭐⭐
**这个文件负责提供API文档给LLM**

**关键点：**
- 第8-33行：加载知识库文件（`tushare_schema.json`）
- 第35-42行：根据用户查询返回相关知识
- **当前实现**：返回全部知识库（简单粗暴）
- **未来优化**：可以只返回相关的部分

**为什么需要？** LLM需要知道Tushare API怎么用，才能生成正确的代码。

#### 6. 看 `core/prompt_templates.py` ⭐⭐⭐
**这个文件定义了给LLM的"任务说明书"**

**关键点：**
- 第1-39行：系统提示词模板
- 告诉LLM：
  - 你是什么角色（金融数据分析助手）
  - 你能用什么工具（pandas, tushare, matplotlib等）
  - 输出格式要求（必须用 ```python 包裹代码）
  - 文件保存位置（workspace/exports/）

---

### 第五阶段：理解GUI界面（可选，较复杂）

#### 7. 看 `gui/state/store.py` ⭐⭐
**这个文件管理界面状态**

**关键点：**
- 使用 Streamlit 的 `session_state` 存储数据
- 存储：消息列表、事件列表、运行状态等
- **为什么需要？** Web界面需要记住用户说了什么，Agent在做什么

#### 8. 看 `gui/app.py` ⭐⭐⭐
**这是Web界面的主入口**

**关键点：**
- 第148-157行：主函数，初始化并渲染界面
- 第29-146行：侧边栏（设置、工作区等）
- 第154行：调用 `render_chat()` 渲染聊天界面

#### 9. 看 `gui/components/chat.py` ⭐⭐⭐⭐
**这是聊天界面的核心**

**关键点：**
- 第193-241行：`render()` 函数 - 渲染聊天界面
- 第101-191行：`process_response()` 函数 - 处理用户输入
  - 第118行：调用 `stream_agent()` 获取流式响应
  - 第120-184行：解析并显示各种事件（思考、执行、结果等）

---

### 第六阶段：理解工具函数（辅助）

#### 10. 看 `tools/tushare_api.py` ⭐⭐
**这是Tushare API的简单封装**

**关键点：**
- 第19-21行：获取股票日线数据
- 第28-40行：根据股票名称查找股票代码
- **为什么需要？** 用户说"茅台"，需要转换成"600519.SH"

---

## 🔍 关键概念解释

### 1. **Code Interpreter 模式**
- 用户说："获取茅台的数据"
- LLM生成代码：`pro.daily(ts_code='600519.SH', ...)`
- 系统执行代码，返回结果

### 2. **流式输出（Streaming）**
- 普通模式：等LLM全部生成完才显示
- 流式模式：LLM一边生成，一边显示（打字机效果）

### 3. **自我修正（Self-Correction）**
- 代码执行失败 → 把错误信息发给LLM → LLM分析错误 → 重新生成代码 → 再次执行
- 最多重试3次

### 4. **知识库增强（RAG）**
- LLM不知道Tushare API怎么用
- 把API文档（Schema）发给LLM
- LLM就能生成正确的代码

---

## 🛠️ 实践建议

### 方法1：跟着数据流走
1. 用户输入："获取茅台数据"
2. 找到 `main.py` 第33行，看如何调用 `agent_workflow`
3. 进入 `core/agent_engine.py`，看第28行开始的流程
4. 看第104行，代码如何执行
5. 进入 `tools/code_executor.py`，看第50行如何执行
6. 返回结果，看第107-117行如何处理

### 方法2：从简单到复杂
1. 先理解 `main.py`（最简单）
2. 再理解 `agent_engine.py` 的核心流程
3. 然后理解 `code_executor.py` 如何执行
4. 最后理解GUI部分（如果感兴趣）

### 方法3：运行并调试
1. 运行 `python main.py`
2. 输入一个简单请求："获取600519.SH在2023-01-01到2023-01-31的数据"
3. 在关键位置加 `print()` 看数据流
4. 单步调试，理解每一步发生了什么

---

## 📝 阅读检查清单

- [ ] 理解了 `main.py` 的基本流程
- [ ] 理解了 `agent_workflow` 的5个步骤
- [ ] 理解了代码如何从LLM响应中提取
- [ ] 理解了 `code_executor` 如何执行代码
- [ ] 理解了知识库如何帮助LLM生成代码
- [ ] 理解了自我修正机制
- [ ] （可选）理解了GUI界面的工作方式

---

## 💡 常见问题

**Q: 为什么代码要在子进程中执行？**
A: 安全考虑。如果用户代码有问题（死循环、内存溢出），不会影响主程序。

**Q: 为什么需要前置代码（Preamble）？**
A: 让LLM生成的代码更简洁。LLM不需要写 `import pandas`、`ts.set_token()` 这些，系统自动注入。

**Q: 流式输出和普通输出有什么区别？**
A: 流式输出实时显示，用户体验更好。普通输出要等全部完成才显示。

**Q: 如果LLM生成的代码有错误怎么办？**
A: 系统会自动重试。把错误信息发给LLM，LLM分析后重新生成代码。最多重试3次。

---

## 🎓 下一步学习

1. **修改提示词**：编辑 `core/prompt_templates.py`，看LLM行为如何变化
2. **添加新功能**：比如支持更多图表类型
3. **优化知识库**：添加更多API文档
4. **改进错误处理**：让自我修正更智能

---

## 📚 推荐阅读顺序总结

```
1. main.py (入口，最简单)
   ↓
2. core/agent_engine.py (核心工作流)
   ↓
3. tools/code_executor.py (代码执行)
   ↓
4. core/knowledge_manager.py (知识库)
   ↓
5. core/prompt_templates.py (提示词)
   ↓
6. gui/ 目录 (GUI界面，可选)
```

**记住：不要一开始就看复杂的文件！从简单到复杂，循序渐进。**

---

祝你学习愉快！有问题随时问！🚀

